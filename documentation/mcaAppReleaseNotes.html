<html>
<head>
<meta http-equiv="Content-Type"
content="text/html; charset=iso-8859-1">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<title>ReleaseNotes.html</title>
</head>
<body>
<h1 align="center">mcaApp Release Notes</h1>
<h2 align="center">Mark Rivers</h2>
<p align="center">&nbsp;</p>
<h2 align="center">Contents</h2>
<p align="left"><a href="#Release 5.01 - October 3, 2000">Release
5.01 - October 3, 2000</a></p>
<p align="left"><a href="#Release 5.0 - September 9, 2000">Release
5.0 - September 9, 2000</a></p>
<p align="left"><a href="#August 22, 2000">August 22, 2000</a></p>
<p align="left"><a href="#December 6, 1999">December 6, 1999</a></p>
<h2 align="center"><a name="Release 5.01 - October 3, 2000">Release
5.01 - October 3, 2000</a></h2>
<p align="left">This new
release is available at <a
href="pub/mcaApp.tar">http://cars.uchicago.edu/software/pub/mcaApp.tar</a>.&nbsp;</p>
<p align="left">The Struck STR7201/SIS 380x device support for the scaler record
is improved so that acquisition terminates within 0.01 seconds of the preset
time.&nbsp; The device support for the MCA record and scaler record are now
compatible, so that it is possible to have scaler and MCA records which
communicate with the device loaded in the IOC simultaneously.&nbsp; The only
restriction is that the only one record type or the other should be
communicating with the hardware at any one time.&nbsp; The Struck8.db database
was modified so that presets work correctly.</p>
<p align="left">A serious bug was fixed in drvSTR7201.c.&nbsp; Previously it was
possible for multiple vxWorks tasks, including the interrupt handler, to be
talking to the hardware simultaneously.&nbsp; This could cause bus errors when
reading the FIFO and other nasty problems.&nbsp; A semaphore was added and
interrupts were disabled at appropriate times to prevent such conflicts.</p>
<p align="left">Changed the task priority of the nmc_status_dispatch and
nmc_inquiry tasks in nmc_comm_subs_1.c to 100 from 50, so that they would be
lower priority than tnetTask.</p>
<p align="left">Added support for the Canberra 9660 DSP module.&nbsp;&nbsp; This
module uses the devIcbMpf device support (same as the AIM MCA device support)
and an MPF server, icbDspServer.cc.&nbsp; The device support uses standard EPICS
records (ao, mbbo, ai, mbbi).</p>
<p align="left">&nbsp;</p>
<h2 align="center"><a name="Release 5.0 - September 9, 2000">Release
5.0 - September 9, 2000</a></h2>
<p align="left">This release of mcaApp is intended primarily to
improve performance with the Canberra AIM MCA hardware. The new
release is available at <a
href="pub/mcaApp.tar">http://cars.uchicago.edu/software/pub/mcaApp.tar</a>.
The main enhancements are:</p>
<ol>
    <li><p align="left">To make the low-level AIM support
        routines able to send commands to multiple AIMs in
        parallel, i.e. without waiting for the response from one
        AIM before sending a command to another.&nbsp; This is
        necessary to improve the performance of systems with
        multiple AIMs being used for multi-element detectors.</p>
    </li>
    <li><p align="left">To make the device support for the AIM be
        &quot;asynchronous&quot;.&nbsp; In previous versions the
        AIM device support was &quot;synchronous&quot;, meaning
        that the MCA record waited for a response from the AIM
        before returning.&nbsp; Since the AIM can take 50-100
        msec to respond to some commands, this was poor EPICS
        programming practice.&nbsp; It would cause the EPICS scan
        tasks to wait for extended periods of time, particularly
        if many MCA records were being used.</p>
    </li>
    <li><p align="left">To improve the performance of the AIM
        device support when used with multiplexors, i.e. multiple
        MCA records per AIM ADC port.</p>
    </li>
    <li><p align="left">To modify the multi-element detector
        databases to process MCA records in parallel, taking
        advantage of changes 1) and 2) above.</p>
    </li>
</ol>
<p align="left">One result of these changes is that the overhead
with multielement detector systems will be reduced proportionally
by the number of AIMs in the system, e.g. a system with 4 AIMs
should have 4 times less overhead than in previous
versions.&nbsp; The overhead time to collect 13 spectra of 2048
channels from a detector with 4 AIMs should now be about 0.25
seconds.</p>
<h3 align="left">Low level AIM support changes</h3>
<p align="left">In the previous versions of the low-level AIM
routines (nmc_comm_subs_1.c, nmc_comm_subs_2.c) there was a
single system-wide interlock and message response queue for AIM
communication.&nbsp; Once a message was sent to any AIM no
further messages could be sent to any AIM until the response from
the first AIM was received.&nbsp; This was a serious performance
limitation when communicating with multiple AIMs.&nbsp; It is
much more efficient to have separate interlocks and message
response queues for each AIM, rather than a single one per
IOC.&nbsp; The low-level AIM routines were re-written to
implement this more efficient model which permits simultaneous
communication with multiple AIM modules.</p>
<h3 align="left">MCA record device support changes for the AIM</h3>
<p align="left">Previous versions the AIM device support was
&quot;synchronous&quot;, meaning that the MCA record waited for a
response from the AIM before returning.&nbsp; Since the AIM can
take 50-100 msec to respond to some commands, this was poor EPICS
programming practice.&nbsp; It would cause the EPICS scan tasks
to wait for extended periods of time, particularly if many MCA
records were being used.&nbsp; However, the low-level AIM
routines are necessarily synchronous since multiple transactions
with the AIM can be required to implement a single high-level
function (e.g. &quot;erase&quot;).</p>
<p align="left">What is needed, therefore, is a separate vxWorks
task for each AIM or AIM port.&nbsp; The record should call the
AIM device support, which in turn sends a message to the
appropriate task and then returns immediately.&nbsp; The task
communicates synchronously with the AIM, and then issues a
callback to record support when the AIM communication is
complete.</p>
<p align="left">The solution to this problem turned out to be
quite simple, since this is exactly what the Message Passing
Facility, MPF is intended to do.&nbsp; In fact there was already
MPF device support for the MCA record for the Acromag IP330 ADC
when used as a waveform digitizer.&nbsp; All that needed to be
done was to take this device support (devMcaIp330.cc) and convert
it to a general MCA device support interface.&nbsp; This layer
does not need to know anything about the particular MCA device,
its role is simply to pass messages from the MCA record to an MPF
server.&nbsp; The new file devMcaMpf.cc implements this
device-independent layer.&nbsp; All of the device dependent code
is now in the specific MPF server.</p>
<p align="left">For the Acromag IP330 ADC the existing
Ip330SweepServer.cc was rewritten slightly to handle the more
general messages from devMcaMpf.cc.&nbsp; Ip330Sweep.cc was
rewritten slightly to handle live-time as well as real-time
messages. This new version of ip330App must be used when
upgrading to this release of mcaApp. It is available at <a
href="pub/ip330App.tar">http://cars.uchicago.edu/software/pub/ip330App.tar</a></p>
<p align="left">A new MPF server, mcaAIMServer.cc was written to
communicate with AIM modules.&nbsp; There is one such server per
AIM ADC port, e.g. up to two servers per AIM.&nbsp; This server
is basically just a rewrite of the code which was previously in
devMCA_AIM.c.&nbsp; The flow of control for communication with
the AIM is now:</p>
<ul>
    <li><p align="left">mcaRecord processes, calling a function
        in devMcaMpf</p>
    </li>
    <li><p align="left">devMcaMpf sends a message to mcaAIMServer
        and returns to immediately to mcaRecord. mcaRecord
        returns immediately to EPICS.</p>
    </li>
    <li><p align="left">mcaAIMServer, which runs as a separate
        vxWorks task,&nbsp; sends one or more messages to the AIM
        and waits for the replies.</p>
    </li>
    <li><p align="left">When the replies are all received
        mcaAIMServer sends a message back to
        devMcaMpf.&nbsp;&nbsp;</p>
    </li>
    <li><p align="left">devmcaMpf issues a callback to mcaRecord,
        which calls devMcaMpf again to complete the operation.</p>
    </li>
</ul>
<p align="left">This scheme properly implements asynchronous
record processing, so that AIM communication no longer causes the
EPICS scan tasks to wait.</p>
<p align="left">mcaAIMServer.cc implements several optimizations
to improve performance when used with multiplexors, typically
used with multielement detectors.&nbsp; When a multiplexor is
used there are multiple &quot;signals&quot; on a single AIM ADC
port&nbsp;or mcaAIMServer. The following optimizations are now
implemented:</p>
<ul>
    <li><p align="left">If an Erase command is sent for signal 0
        then the AIM memory for <b>all</b> of the signals is
        erased.&nbsp; This is done in a single message to the
        AIM.&nbsp; This is significantly faster than sending
        multiple messages to erase smaller blocks of AIM memory.
        Multielement detector databases take advantage of this
        optimization by only sending Erase commands for the <b>first</b>
        signal (0) on each port.&nbsp; It is not necessary to
        send erase commands for the other signals, because the
        memory will be erased when signal 0 is erased. The
        elapsed real time, elapsed live time and elapsed total
        counts are common to all signals on each port, and these
        will also be reset when an erase is sent to signal 0.</p>
    </li>
    <li><p align="left">The results of Read Status commands
        (elapsed live time, elapsed real time, elapsed total
        counts, and acquiring status) are cached in the
        mcaAIMServer object.&nbsp; If a Read Status command is
        received by mcaAIMServer then this will result in a
        network message being sent to the AIM only if:</p>
        <ul>
            <li><p align="left">The Read Status command is for
                signal 0</p>
            </li>
        </ul>
        <p>or </p>
        <ul>
            <li><p align="left">The time since the most recent
                Read Status command was sent to the AIM is more
                than 0.1 seconds</p>
            </li>
        </ul>
        <p>This optimization results in significantly fewer
        network messages being sent to the AIM, since the status
        for all signals is typically read in rapid succession,
        and the cached value will generally be used for all but
        signal 0. </p>
    </li>
</ul>
<h3>Struck/SIS Driver Changes</h3>
<p>There was a problem in previous versions of drvSTR7201.c for
the prescale feature of the SIS 380x. The internal prescale
counter was not correctly reset when the prescale value was
changed. This could be a serious problem when changing from a
large prescale value to a small prescale value, since the first
dwell period after the change could require many more channel
advance pulses (internal or external) than it should. SIS has
provided additional information on how to properly program the
prescaler, and the problem is now fixed.</p>
<h3>MCA record changes</h3>
<p>A new field, .ERST (ERase/STart) was added to the
mcaRecord.&nbsp; Writing a 1 to this field causes the record to
execute an Erase and a Start in a single operation, rather than
the two operations required if the .ERAS and .STRT fields are
written to separately.&nbsp; Adding this field has two beneficial
effects:</p>
<ul>
    <li>It significantly simplifies the databases (mca.db,
        16element.db, etc.) because the logic for Erase/Start is
        now very simple.</li>
    <li>It significantly improves performance because it saves a
        Read Status call to device support, which in the case of
        the AIM would require a network message to the AIM.</li>
</ul>
<p>The <code>init_record </code>routine was changed to set flags
which cause all of fields of interest to device support (.PRTM,
.PLTM, .NUSE, etc.) to be sent to device support the first time
the record processes.&nbsp; 
In principle all databases which create MCA records should now
set PINI=&quot;YES&quot; so that the MCA record processes once at iocInit 
and all of these values are sent to device support at that time.
<i>However</i> this does <i>not work</i> for MPF devices yet (AIM, IP330)
because at record initialization the MPF server has typically not yet connected
and it gets the message passing out of sync if PINI is YES.  For now we do not
set PINI=YES in the MCA databases.  
The MPF device support synchronizes the device
with the record when the MPF server connects. Furthermore the record will
synchronize again the first time the record processes.</p>
<p>A logic bug was fixed which caused the record to misbehave if
the .READ field was set while a Read callback was pending.</p>
<h3>Database Changes</h3>
<p>mca.db was simplified with the removal of a fanout and swait
record because EraseStart now uses the .ERST field in the MCA
record.&nbsp; The current version is mca_5.3.db.</p>
<p>16element.db was modified as follows:</p>
<ul>
    <li>EraseStart now uses the .ERST field of the record and
        only processes the records with signal=0.&nbsp; It no
        longer links to StartAll and EraseAll.</li>
    <li>All fanout links were changed from PP to CA links.&nbsp;
        This is necessary to get EPICS to processes the linked
        records in &quot;parallel&quot; rather than waiting for
        each one to complete before starting the next.</li>
    <li>A new Busy record, AcquireBusy, was added.&nbsp; This
        record is needed for the scan record to work correctly
        now that the fanout outputs are CA rather than PP.&nbsp;
        This record is set to 1 when StartAll or EraseStart is
        set to 1, and is cleared when Acquiring makes a
        transition from 1 to 0.</li>
    <li>The Acquiring record was changed to look at the acquire
        status of all 16 MCAs, rather than just the 4 MCAs with
        signal=0.&nbsp; The reason for this is that it is
        possible that the records with signal=0 will all finish
        and set .ACQG=0 before some record with signal!=0 has set
        .ACQG=0.&nbsp; The record is only guaranteed to read the
        data from the AIM when it sets .ACQG=0, and thus some
        records might not have read their data yet if they are
        not involved in the Acquiring calculation.&nbsp; When the
        Acquiring record makes a transition from 1 to 0 it now
        clears the AcquireBusy record as well as processing the
        StopScaler record.</li>
</ul>
<p>A new database, simple_mca.db was created.&nbsp; It replaces
simple_mca_aim.db and simple_mca_struck.db. Template files which
call simple_mca.db must now pass DTYP, INP, and PREC.</p>
<h3>Building applications</h3>
<p>Because the AIM device support now requires MPF there are some
changes required in building applications which use the AIM. When
building an application directory &lt;myApp&gt;/src in the past
it was only necessary to include in Makefile.Vx the lines:</p>
<pre>include $(SHARE)/mcaApp/src/mcaLIBOBJS
LIBOBJS += $(MCALIBOBJS)</pre>
<p>and in &lt;APP&gt;Include.dbd the line</p>
<pre>include &quot;mcaShare.dbd&quot;</pre>
<p>Because MPF can pass messages across the network, including
across the backplane to an auxilliary CPU, the user has choices
as to where to actually run the mcaAIMServer MPF server. I
recommend running it locally on the same CPU which is running the
EPICS MCA record, since this will minimize the MPF communications
overhead. In this case it is necessary to load the basic MPF
server code and the mcaAimServer code onto this CPU. This may not
be currently happening if the IOC is set up to run the MPF server
code only on an auxilliary CPU. The solution I recommend is to
build a separate MPF server library in &lt;myApp&gt;/src by
adding the following lines to Makefile.Vx</p>
<pre>include $(SHARE)/ipApp/src/mpfServerLIBOBJS
include $(SHARE)/mcaApp/src/mpfServerLIBOBJS
#----------------------------------------
# ADD RULES AFTER THIS LINE
mpfServLib: $(MPFSERVERLIBOBJS)
$(LINK.c) $@ $(MPFSERVERLIBOBJS)</pre>
<p>This works by looking at the files ipApp/mpfServerLIBOBJS and
mcaApp/mpfServerLIBOBJS to make a list of all the object files
required to build mpfServerLib. Users may need to get the latest
version of ipApp from <a
href="pub/ipApp.tar">http://cars.uchicago.edu/software/pub/ipApp.tar</a>
or from Tim Mooney in order to get mpfServerLIBOBJS. If
mpfServerLib is built this way and is loaded on a CPU which does
not have IP slots (e.g. MV167 or PPC) then there is some unused
code, but the memory cost is not large.</p>
<p>There is a problem with the current version of DevMpf.cc in
the MPF distribution. DevMpf prevents a record from sending
multiple messages to device support during one record processing.
This problem will be fixed in the next release of MPF. Meanwhile
in order for the MCA record to work with MPF the following lines
must be <strong>deleted</strong> from DevMpf::read_write in
DevMpf.cc.</p>
<pre>if(pcommon-&gt;pact==TRUE &amp;&amp; pdevMpf-&gt;replyMessage==0) {
  if(DevMpfDebug) epicsPrintf(&quot;%s PACT true and no reply message\n&quot;);
  recGblSetSevr(pcommon,COMM_ALARM,INVALID_ALARM);
  return(MPF_NoConvert);
}
</pre>
<h3>vxWorks Startup File</h3>
<p>The vxWorks startup file must be changed to use the new AIM
device support code.</p>
<p>The following lines should be added near the beginning, after
loading iocCore and all of your other support libraries:</p>
<pre># Initialize local MPF connection
ld &lt; mpfServLib
routerInit
localMessageRouterStart(0)
</pre>
<p>Note that some or all of these lines may already exist in your
startup file, depending upon whether you are currently running
MPF at all, and/or are running a local MPF server.</p>
<p>The following lines show the global variables to turn on
debugging at various levels. aimDebug turns on debugging for the
low level AIM routines, etc. Setting these flags to higher
numbers (1-10) turns on increasingly more verbose debugging
messages.</p>
<pre>mcaRecordDebug = 0
devMcaMpfDebug = 0
mcaAIMServerDebug = 0
aimDebug = 0</pre>
<p>The AIMSetup() command which was previously used to indicate
the maximum number of AIMs in a system is no longer used.
Allocation of structures for each AIM now happens in AIMConfig
when the mcaAIMServer object is created.</p>
<p>The format of the AIMConfig() command has changed. The syntax
is now:</p>
<pre>### AIMConfig(serverName, ethernetAddress, port, maxChans, maxSignals,
### maxSequences, ethernetDevice, queueSize)
AIMConfig(&quot;AIM1/1&quot;, 0x6E6, 1, 2048, 1, 1, &quot;ei0&quot;, 100)
AIMConfig(&quot;AIM1/2&quot;, 0x6E6, 2, 2048, 4, 1, &quot;ei0&quot;, 100)
</pre>
<p><font face="Times New Roman"><code>serverName</code></font>,
the MPF server name, is arbitrary, it just must be the same in
the AIMConfig and dbLoadRecords commands. The name of the vxWorks
task will be the name of the MPF server with the letter
&quot;t&quot; in front of it, e.g. <font face="Times New Roman"><code>tAIM1/1</code></font>
in this case. </p>
<p><font face="Times New Roman"><code>ethernetAddress</code></font>
is the low order 16 bits of the AIM Ethernet address, which is
printed on the front of the AIM.</p>
<p><font face="Times New Roman"><code>port</code></font> is the
AIM ADC port for this server, 1 or 2.</p>
<p><font face="Times New Roman"><code>maxChans, maxSignals </code></font>and
<font face="Times New Roman"><code>maxSequences</code></font> are
the maximum number of channels, signals (used for multiplexors
and Canberra MCS units) and sequences (used for time-resolved
spectroscopy). The amount of memory required in the AIM is <font
face="Times New Roman"><code>maxChans*maxSignals*maxSequences*4 </code></font>bytes.</p>
<p><font face="Times New Roman"><code>ethernetDevice</code></font>
is the name of the vxWorks Ethernet device for the network with
this AIM. This is typically &quot;ei0&quot; for the Motorola 68K
CPUs and &quot;dc0&quot; for the Motorola PowerPC CPUs.</p>
<p><font face="Times New Roman"><code>queueSize</code></font> is
the size of the MPF message queue for this server. 100 should be
plenty.</p>
<p>The format of the dbLoadRecords command has also changed:</p>
<pre>
dbLoadRecords(&quot;share/mcaApp/Db/mca.db&quot;, &quot;P=13IDC:,M=aim_adc1,DTYPE=MPF MCA,INP=#C0 S0 @AIM1/1,NCHAN=2048&quot;)
dbLoadRecords(&quot;share/mcaApp/Db/mca.db&quot;, &quot;P=13IDC:,M=aim_mcs1,DTYPE=MPF MCA,INP=#C0 S0 @AIM1/2,NCHAN=2048&quot;)
</pre>
<p>The DTYPE field is now &quot;MPF MCA&quot; rather than
&quot;Canberra AIM MCA&quot;. The &quot;card&quot; (#Cn) is now
the identification number of the MPF server (e.g. 0=local MPF
server, 1=remote MPF server) rather than a number specific to
each AIM. The parm field is now @serverName to specify the MPF
server for this AIM.</p>
<p>Example multielement template file and command file.</p>
<p>The following is an example of a vxWorks command file script
to load everything for the GSECARS 16 element detector which uses
2 AIMs with multiplexors. This file is invoked with
&quot;&lt;16element.cmd&quot;.</p>
<pre># AIMConfig(mpfServer, ethernet_address, port, maxChans,
# maxSignals, maxSequences, ethernetDevice, queueSize)
AIMConfig(&quot;AIM1/1&quot;, 0x8d7, 1, 4096, 4, 1, &quot;ei0&quot;, 100)
AIMConfig(&quot;AIM1/2&quot;, 0x8d7, 2, 4096, 4, 1, &quot;ei0&quot;, 100)
AIMConfig(&quot;AIM2/1&quot;, 0x3ec, 1, 4096, 4, 1, &quot;ei0&quot;, 100)
AIMConfig(&quot;AIM2/2&quot;, 0x3ec, 2, 4096, 4, 1, &quot;ei0&quot;, 100)
dbLoadRecords(&quot;share/mcaApp/Db/16element.db&quot;,&quot;P=13GE1:med:&quot;)
dbLoadTemplate(&quot;16element.template&quot;)
### Struck/SIS as simple scaler for ICR
STR7201Setup(1,0xA0000000,220,6)
STR7201Config(0, 16, 100)
dbLoadRecords(&quot;share/mcaApp/Db/STR7201scaler.db&quot;,&quot;P=13GE1:med:, S=scaler1, C=0&quot;)
</pre>
<p align="left">The following is the 16element.template file
which the above file loads:</p>
<div align="left">
<pre>file share/mcaApp/Db/simple_mca.db
{
pattern
{    P,      M,     DTYP,        INP       PREC, CHANS}
{13GE1:med: mca1 &quot;MPF MCA&quot;, &quot;#C0 S0 @AIM1/1&quot;, 3, 2048}
{13GE1:med: mca2 &quot;MPF MCA&quot;, &quot;#C0 S1 @AIM1/1&quot;, 3, 2048}
{13GE1:med: mca3 &quot;MPF MCA&quot;, &quot;#C0 S2 @AIM1/1&quot;, 3, 2048}
{13GE1:med: mca4 &quot;MPF MCA&quot;, &quot;#C0 S3 @AIM1/1&quot;, 3, 2048}
{13GE1:med: mca5 &quot;MPF MCA&quot;, &quot;#C0 S0 @AIM1/2&quot;, 3, 2048}
{13GE1:med: mca6 &quot;MPF MCA&quot;, &quot;#C0 S1 @AIM1/2&quot;, 3, 2048}
{13GE1:med: mca7 &quot;MPF MCA&quot;, &quot;#C0 S2 @AIM1/2&quot;, 3, 2048}
{13GE1:med: mca8 &quot;MPF MCA&quot;, &quot;#C0 S3 @AIM1/2&quot;, 3, 2048}
{13GE1:med: mca9 &quot;MPF MCA&quot;, &quot;#C0 S0 @AIM2/1&quot;, 3, 2048}
{13GE1:med: mca10 &quot;MPF MCA&quot;, &quot;#C0 S1 @AIM2/1&quot;, 3, 2048}
{13GE1:med: mca11 &quot;MPF MCA&quot;, &quot;#C0 S2 @AIM2/1&quot;, 3, 2048}
{13GE1:med: mca12 &quot;MPF MCA&quot;, &quot;#C0 S3 @AIM2/1&quot;, 3, 2048}
{13GE1:med: mca13 &quot;MPF MCA&quot;, &quot;#C0 S0 @AIM2/2&quot;, 3, 2048}
{13GE1:med: mca14 &quot;MPF MCA&quot;, &quot;#C0 S1 @AIM2/2&quot;, 3, 2048}
{13GE1:med: mca15 &quot;MPF MCA&quot;, &quot;#C0 S2 @AIM2/2&quot;, 3, 2048}
{13GE1:med: mca16 &quot;MPF MCA&quot;, &quot;#C0 S3 @AIM2/2&quot;, 3, 2048}
}
</pre>
</div><div align="left">
<pre>file share/mcaApp/Db/icb_amp.db
{
pattern
{P,         AMP,   ICB}
{13GE1:med: amp1 NI8D7:1}
{13GE1:med: amp2 NI8D7:2}
{13GE1:med: amp3 NI8D7:3}
{13GE1:med: amp4 NI8D7:4}
{13GE1:med: amp5 NI8D7:5}
{13GE1:med: amp6 NI8D7:6}
{13GE1:med: amp7 NI8D7:8}
{13GE1:med: amp8 NI8D7:9}
{13GE1:med: amp9 NI3EC:1}
{13GE1:med: amp10 NI3EC:2}
{13GE1:med: amp11 NI3EC:3}
{13GE1:med: amp12 NI3EC:4}
{13GE1:med: amp13 NI3EC:5}
{13GE1:med: amp14 NI3EC:6}
{13GE1:med: amp15 NI3EC:8}
{13GE1:med: amp16 NI3EC:9}
}</pre>
</div><div align="left">
<pre>
file share/mcaApp/Db/icb_adc.db
{
pattern
{P,         ADC,   ICB}
{13GE1:med: adc1 NI8D7:B}
{13GE1:med: adc2 NI8D7:0}
{13GE1:med: adc3 NI3EC:B}
{13GE1:med: adc4 NI3EC:7}
}
file share/mcaApp/Db/icb_hvps.db
{
pattern
{P,         HVPS,   ICB}
{13GE1:med: hvps1 NI3EC:A}
}
</pre>
</div>
<h2 align="center"><a name="August 22, 2000">August 22, 2000</a></h2>
<p>drvSTR7201.c for the Struck 7201 and SIS 380x had some serious
problems:</p>
<ul>
    <li>Things were not initialized to zero, and this could cause
        problems.&nbsp; </li>
    <li>There is a serious flaw in the SIS380x firmware. It does
        not reset the prescaler counter to 0 when new prescale
        value is written. This means, for example, that if one
        were using internal channel advance with 0.1 second dwell
        time (prescaler=1e6) and then switched to external
        channel advance, it will take a random number between 0
        and 1e6 external channel advance pulses before it counts
        the first channel. This could take weeks! I have added a
        workaround in the driver until the firmware is fixed.</li>
    <li>Floating point registers were not being saved in
        interrupt service routine</li>
</ul>
<p>Tim Mooney found and fixed a problem in the ICB routines which
was causing crashes if an unknown ICB module, such as the TCA or
DSP was present.</p>
<p>Made changes to the AIM software to allow it to run on the
PowerPC. </p>
<p>Improved performance of the erase command in mcaRecord.c by
not sending a read_data request to device support after an erase,
just clear the array in the record and post a monitor on the VAL
field.</p>
<p>Previously the<font face="Times New Roman"><code>
nmc_acqu_setelapsed</code></font> command (in <font
face="Times New Roman"><code>nmc_user_subs_2.c)</code></font>
always did the following: </p>
<ul>
    <li>Queried acquisition status </li>
    <li>Turned acquisition off (even if it was off) </li>
    <li>Set the elapsed times </li>
    <li>Turned acquisition back on if it had been on </li>
</ul>
<p><font face="Times New Roman"><code>nmc_acqu_setelapsed</code></font>
cannot set the elapsed times if the AIM is acquiring. However,
this method has a lot of extra overhead if the AIM is not
acquiring. </p>
<p>Moved the logic into device support. Only turn off acquisition
if it is determined to be on by the ACQG field in the record.
This improves performance. It also improves accuracy if the AIM
is acquiring, because the erase and setelapsed will now both be
done with acquisition off. </p>
<p>&nbsp; </p>
<h2 align="center"><a name="December 6, 1999">December 6, 1999</a></h2>
<p align="left">This documents the changes made to mcaApp since
synApps_R3.13.1.1. The changes have been substantial, and users
must make a number of simultaneous changes in order to use the
new release:</p>
<ul>
    <li>Use the new mcaRecord (mcaRecord.dbd, mcaRecord.c)</li>
    <li>Use the new databases (mca.db, 13element.db, 3element.db,
        Struck8.db) </li>
    <li>Use the new IDL code (mca__define.pro,
        epics_mca__define.pro, med__define.pro,
        epics_med__define.pro, mca_display__define.pro, etc.)</li>
    <li>Use the new MEDM ADL files (mca.adl, mca_small.adl,
        mcaSetup.adl, 13element.adl, 3element.adl, Struck8.adl,
        etc.)</li>
    <li>Modify startup files st.cmd, to use the INP parameter
        rather than CARD and SIGNAL. This change is necessary in
        order to accomodate new device support for the IP330 ADC
        and the XIA DXP CAMAC module.</li>
</ul>
<p>The changes to mcaApp are described below in roughly
decreasing order of significance.</p>
<h3>Changes to databases</h3>
<p>The databases mca.db, 3element.db and 13element.db have been
changed significantly. A new database, Struck8.db has been added
to support 8 channel data acquisition using the Struck ST7201 or
SIS 380x multichannel scaler.</p>
<ul>
    <li>Previous versions of these databases had a PV called
        $(P)Start. This PV acted like the .CNT field in the
        Joerger scaler, i.e. it was 1 when the MCA was counting,
        0 when it was done. Writing a 1 to this PV would erase
        the spectra and start acquisition, while writing a 0
        would stop acquisition. The PV would also automatically
        change state if acquisition was started or stopped by any
        other means, for example when the preset acquisition time
        was reached. Implementation of this PV made the databases
        quite complex, and subject to a number of race conditions
        which made them unreliable. In order to simplify the
        databases and make them much more robust the single
        $(P)Start PV has been eliminated. It has been replaced by
        several separate PVs in each database.<ul>
            <li><font face="Times New Roman"><tt>$(P)EraseStart</tt></font>.
                Processing this PV (i.e. writing anything to it)
                causes the spectra to tbe erase and then
                aquisition to start. It simply processes <font
                face="Times New Roman"><tt>$(P)Erase</tt></font>
                or <font face="Times New Roman"><tt>$(P)EraseAll </tt></font>and
                then <font face="Times New Roman"><tt>$(P)Start </tt></font>or
                <font face="Times New Roman"><tt>$(P)StartAll.</tt></font>
                This is now the PV which should be used as a
                detector trigger in the scan record.</li>
            <li><font face="Times New Roman"><tt>$(P)Erase</tt></font>(in
                mca.db) or <font face="Times New Roman"><tt>$(P)EraseAll</tt></font>
                (in the multi-element databases 3element.db,
                13element.db and Struck8.db). Processing this PV
                (i.e. writing anything to it) causes the spectra
                to be erased.</li>
            <li><font face="Times New Roman"><tt>$(P)Start </tt></font>(in
                mca.db) or <font face="Times New Roman"><tt>$(P)StartAll</tt></font>
                (in the multi-element databases). Processing this
                PV (i.e. writing anything to it) causes aqusition
                to start without first erasing the spectra.</li>
            <li><font face="Times New Roman"><tt>$(P)Stop </tt></font>(in
                mca.db) or <font face="Times New Roman"><tt>$(P)StopAll</tt></font>
                (in the multi-element databases). Processing this
                PV (i.e. writing anything to it) causes aqusition
                to stop.</li>
        </ul>
        <p>There MEDM .adl files (mca.adl, mca_small.adl,
        13element.adl, etc.) have been changed to reflect these
        changes in the databases.</p>
    </li>
    <li>The previous version of mca.db used the parameters CARD
        and SIGNAL to specify the hardware address of the input
        for the AIM and Struck/SIS. However, these parameters are
        not sufficient for the new Ip330Sweep and DXP device
        support, which require additional addressing information.
        Thus, these parameters were eliminated, and replaced by
        the single INP parameter, which is used to provide
        complete addressing information. Unfortunately this means
        that all st.cmd files will need to be modified. For the
        AIM replace lines like the following: <blockquote>
            <p><font face="Times New Roman"><tt>dbLoadRecords(&quot;share/mcaApp/Db/mca.db&quot;,
            &quot;P=13BMD:, M=aim_adc1, DTYPE=Canberra AIM MCA,
            CARD=0, SIGNAL=0, NCHAN=2048&quot;)</tt></font></p>
            <p>with</p>
            <p><font face="Times New Roman"><tt>dbLoadRecords(&quot;share/mcaApp/Db/mca.db&quot;,
            &quot;P=13BMD:, M=aim_adc1, DTYPE=Canberra AIM MCA,
            INP=#C0 S0, NCHAN=2048&quot;)</tt></font></p>
            <p>For the Struck/SIS replace lines like:</p>
        </blockquote>
        <blockquote>
            <p><font face="Times New Roman"><tt>dbLoadRecords(&quot;share/mcaApp/Db/mca.db&quot;,
            &quot;P=13LAB:, M=mca_str2, DTYPE=Struck STR7201 MCS,
            NCHAN=1024, CARD=0, SIGNAL=1&quot;)</tt></font></p>
        </blockquote>
        <blockquote>
            <p>with</p>
        </blockquote>
        <blockquote>
            <p><font face="Times New Roman"><tt>dbLoadRecords(&quot;share/mcaApp/Db/mca.db&quot;,
            &quot;P=13LAB:, M=mca_str2, DTYPE=Struck STR7201 MCS,
            NCHAN=1024, INP=#C0 S1&quot;)</tt></font></p>
            <p>For the Ip330Sweep use lines like</p>
            <p><font face="Times New Roman"><tt>dbLoadRecords(&quot;share/mcaApp/Db/mca_ip330.db&quot;,
            &quot;P=13LAB:, M=mip330_1, DTYPE=ip330Sweep,
            NCHAN=2048, INP=#C1 S0 @c-Ip330Sweep&quot;)</tt></font></p>
        </blockquote>
    </li>
    <li>The previous version of these databases had a PV called
        IdlBusy. This PV was intended to be used to synchronize
        with IDL running on a workstation. In particular it was
        intended to be used to cause a scan to wait until IDL had
        written spectral data to disk before continuing the scan.
        However, IdlBusy was not correctly implemented in any of
        these databases, and was not being used by the IDL
        EPICS_MCA or EPICS_MED class libraries. The new databases
        do implement this concept in a robust and general way.
        The PV is no longer called IdlBusy, but rather is called
        ClientWait. Each database contains records like the
        following: <pre>
grecord(bo,&quot;$(P)$(M)Start&quot;) {
        field(OMSL,&quot;closed_loop&quot;)
        field(DOL,&quot;1&quot;)
        field(OUT,&quot;$(P)$(M).STRT  CA MS&quot;)
        field(FLNK,&quot;$(P)$(M)SetClientWait&quot;)
}
# These records are to synchronize with IDL or another client
grecord(bo,&quot;$(P)$(M)EnableWait&quot;) {
      field(ZNAM,&quot;Disable&quot;)
      field(ONAM,&quot;Enable&quot;)
}
grecord(bo,&quot;$(P)$(M)SetClientWait&quot;) {
      field(DISV,&quot;0&quot;)
      field(SDIS,&quot;$(P)$(M)EnableWait NPP NMS&quot;)
      field(OMSL,&quot;closed_loop&quot;)
      field(DOL,&quot;1&quot;)
      field(OUT,&quot;$(P)$(M)ClientWait PP MS&quot;)
}
grecord(busy,&quot;$(P)$(M)ClientWait&quot;) {}
</pre>
        <p>The logic behind these records is quite simple. <font
        face="Times New Roman"><tt>EnableWait</tt></font> is used
        to enable or disable waiting for <font
        face="Times New Roman"><tt>ClientWait</tt></font>. It is
        disabled at iocInit, and can be enabled/disabled from
        mcaSetup.adl. Each time acquisition is started via the
        database <font face="Times New Roman"><tt>SetClientWait</tt></font>
        is processed. If <font face="Times New Roman"><tt>EnableWait</tt></font>
        is enabled, then <font face="Times New Roman"><tt>ClientWait</tt></font>
        changes to 1. If a scan record detector trigger was what
        caused acquisition to start, then the scan will wait
        until <font face="Times New Roman"><tt>ClientWait</tt></font>
        goes back to 0 before it moves the positioners to the
        next point. IDL or another client can read the data from
        the MCA record, write it to disk (or do anything else
        with it) and then write 0 to <font face="Times New Roman"><tt>ClientWait</tt></font>
        when it is OK for the scan to proceed. The IDL procedures
        EPICS_MCA::WRITE_FILE and EPICS_MED::WRITE_FILE have been
        changed to set <font face="Times New Roman"><tt>ClientWait</tt></font>
        to 0 after the data are written to disk. There are two
        minor limitations of this synchronization mechanism:</p>
        <ul>
            <li>If the user forgets to disable <font
                face="Times New Roman"><tt>EnableWait </tt></font>and
                an IDL or other client is not running, then the
                scan will hang. However, there is a control in
                mcaSetup.adl to manually clear (or set) <font
                face="Times New Roman"><tt>ClientWait</tt></font>.</li>
            <li>Since the IDL file writing procedures always
                clear <font face="Times New Roman"><tt>ClientWait
                </tt></font>it is important that this be done
                last if there is a complex set of things to be
                done by the client at each point in the scan.</li>
        </ul>
    </li>
</ul>
<p>&nbsp;</p>
<h3>Changes to MEDM .adl files</h3>
<ul>
    <li>Added new .adl files for the Struck8 database
        (Struck8.adl, Struck8_plots.adl, Struck8_cal.adl
        Struck8_ROI.adl)</li>
    <li>Modified mca.adl, mca_small.adl, 13element.adl,
        3element.adl to reflect the databases changes to <font
        face="Times New Roman"><tt>Start, StartAll, EraseStart,</tt></font>
        etc.</li>
    <li>Added <font face="Times New Roman"><tt>EnableWait</tt></font>
        and <font face="Times New Roman"><tt>ClientWait</tt></font>
        to 13element.adl, 3element.adl and mcaSetup.adl</li>
    <li>Added individual plot menus to 13element.adl and
        3element.adl.</li>
    <li>Changed format of <font face="Times New Roman"><tt>.DWEL</tt></font>
        to exponential in mcaSetup.adl so that small dwell times
        are legible.</li>
</ul>
<p>&nbsp;</p>
<h3>New device support - Ip330Sweep</h3>
<p>New device support has been added for the Acromag IP-330 ADC
acting as a waveform recorder/transient digitizer, i.e. the MCA
spectrum contains voltage as a function of time. This device
support allows one to capture up to 32 waveforms nearly
simultaneously. Times per point as short as 100 microseconds are
possible with up to 6 waveforms. The device support and
documentation is not in mcaApp, but rather in mpf/ip330App. This
device support requires MPF. It can run either on a single CPU
(e.g. MVME162 running both EPICS and MPF) or on a multiple CPU
system (e.g. MVME167 running EPICS and MVME162 running MPF).</p>
<p>&nbsp;</p>
<h3>Changes to mcaRecord.c and mcaRecord.dbd</h3>
<ul>
    <li>Added RTIM (read time) field. This is the time when the
        data were last read from the hardware. It is used by
        clients to accurately compute counts/second.</li>
    <li>Trimmed the STIM field so precision is only .001 sec </li>
    <li>Support asynchronous device support for read-status and
        read-data. This is required by the IP-330 ADC device
        support which is based on MPF. Added RDNS, ACQP, ERTP,
        ELTP, ACTP, and DWLP fields.</li>
    <li>Allowed device support to change DWEL to reflect actual,
        vs requested, dwell time.</li>
</ul>
<p>&nbsp;</p>
<h3>Changes to devMCA_AIM.c</h3>
<ul>
    <li>Fixed bug with dwell time. Changes to dwell time were
        changing instead the preset real time. The dwell time
        should be ignorred, since the Canberra MCS hardware does
        not support programmable dwell time.</li>
    <li>Minor fixes to eliminate compiler warnings.</li>
</ul>
<p>&nbsp;</p>
<h3>Changes to Makefile.Host</h3>
<ul>
    <li>Added mca.h to INC. Required so MPF can access it.</li>
</ul>
<p>&nbsp;</p>
<h3>Changes to Makefile.Vx and mcaLIBOBJS</h3>
<ul>
    <li>Added icbAdcSub.o, icbAmpSub.o, and icbHVPSSub.o to
        mcaLibOBJS, removed as separate products in Makefile.Vx.</li>
    <li>Added device support for Ip330Sweep, <font
        face="Times New Roman"><tt>$(MPF_BIN)/devMcaIp330.o</tt></font></li>
</ul>
<p>&nbsp;</p>
<h3>Changes to devSTR7201.c and drvSTR7201.c</h3>
<ul>
    <li>Fixed bug in drvSTR7201.c which caused the IOC to crash
        if the first command after iocInit was a start acquire
        command rather than an erase command.</li>
    <li>Fixed minor bug in the elapsed time logic in
        drvSTR7201.c. If acquisition was manually stopped and
        then restarted the elapsed time was reset to zero. It now
        continues to increase from the value it had when when
        acquisition was stopped.</li>
    <li>Changed <font face="Times New Roman"><tt>#include
        &lt;file&gt;</tt></font> to <font face="Times New Roman"><tt>#include
        &quot;file&quot;</tt></font> for some files so <font
        face="Times New Roman"><tt>gnumake depends</tt></font>
        works correctly. </li>
</ul>
<h3>Changes to icb_control_subs.c, icb_control_subs2.c,
icb_handler_subs.c, icb_read_regs.c, icb_show_modules.c,
nmc_comm_subs_2.c, nmc_test.c, icb_sys_defs.h</h3>
<ul>
    <li>Minor changes to eliminate compiler warnings. Main change
        was to modify files to consistently use <font
        face="Times New Roman"><tt>unsigned char</tt></font>
        rather than <font face="Times New Roman"><tt>char</tt></font>.</li>
</ul>
<p align="left"><strong>Things to do in mcaApp and IDL&nbsp;</strong></p>
<ul>
    <li><p align="left">Update 13element and 3element files</p>
    </li>
</ul>
<ul>
    <li><p align="left">Document changes to IDL code</p>
    </li>
    <li><p align="left">Fix IDL code for get_environment - make
        it actually read current environment with EPICS_MCA and
        EPICS_MED</p>
    </li>
    <li><p align="left">Make spectra_scan a class in EPICS_MCA
        and EPICS_MED</p>
    </li>
</ul>
</body>
</html>
